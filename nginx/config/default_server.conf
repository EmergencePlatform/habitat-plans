{{#if cfg.default_server.charset ~}}
    charset {{cfg.default_server.charset}};
{{~ /if}}

{{#each cfg.default_server.log_ignore_locations as |location| ~}}
location = {{location}} { access_log off; log_not_found off; }
{{/each}}

{{#eachAlive bind.backend.members as |member| ~}}
{{~ #if @first ~}}

root /hab/pkgs/
    {{~ member.pkg.origin}}/
    {{~ member.pkg.name}}/
    {{~ member.pkg.version}}/
    {{~ member.pkg.release}}/
    {{~ #if member.cfg.root ~}}
        {{member.cfg.root}}
    {{~ else ~}}
        web/public
    {{~ /if}};

index {{#if member.cfg.index ~}}
          {{member.cfg.index}}
      {{~ else ~}}
          index.php
      {{~ /if}};

{{#if cfg.http.fastcgi_index ~}}
    error_page 404 /{{cfg.http.fastcgi_index}};
{{~ /if}}

{{#if member.cfg.nginx_server_snippet ~}}
    {{member.cfg.nginx_server_snippet}}
{{~ /if}}

location / {
    try_files $uri $uri/ {{#if cfg.http.fastcgi_index}}/{{cfg.http.fastcgi_index}}?$query_string{{/if}};
}

location ~ \.php$ {
    fastcgi_pass backend;
    include fastcgi.conf;
}
{{~ /if ~}}
{{~ else ~}}
    # no members

    {{#if cfg.default_server.root ~}}
        root {{cfg.default_server.root}};
    {{~ else ~}}
        root {{pkg.path}}/www;
    {{~ /if}}

    {{#if cfg.default_server.index ~}}
        index {{cfg.default_server.index}};
    {{~ else ~}}
        index index.html;
    {{~ /if}}
{{~ /eachAlive}}

{{#if cfg.default_server.snippet ~}}
{{cfg.default_server.snippet}}
{{~ /if}}
